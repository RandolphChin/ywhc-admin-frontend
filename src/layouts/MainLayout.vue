<template>
  <q-layout view="lHh Lpr lFf">
    <q-header elevated>
      <q-toolbar>
        <q-btn
          flat
          dense
          round
          icon="menu"
          aria-label="Menu"
          @click="toggleLeftDrawer"
        />

        <q-toolbar-title> YWHC ÂêéÂè∞ÁÆ°ÁêÜÁ≥ªÁªü </q-toolbar-title>

        <div class="q-gutter-sm row items-center no-wrap">
          <!-- ÂÖ®Â±èÂàáÊç¢ -->
          <q-btn
            flat
            dense
            round
            :icon="$q.fullscreen.isActive ? 'fullscreen_exit' : 'fullscreen'"
            @click="$q.fullscreen.toggle()"
          />

          <!-- Áî®Êà∑ËèúÂçï -->
          <q-btn-dropdown
            flat
            dense
            no-caps
            :label="userInfo?.nickname || 'Áî®Êà∑'"
            icon="account_circle"
          >
            <q-list>
              <q-item clickable v-close-popup @click="goToProfile">
                <q-item-section avatar>
                  <q-icon name="person" />
                </q-item-section>
                <q-item-section>‰∏™‰∫∫‰∏≠ÂøÉ</q-item-section>
              </q-item>

              <q-item clickable v-close-popup @click="changePassword">
                <q-item-section avatar>
                  <q-icon name="lock" />
                </q-item-section>
                <q-item-section>‰øÆÊîπÂØÜÁ†Å</q-item-section>
              </q-item>

              <q-separator />

              <q-item clickable v-close-popup @click="logout">
                <q-item-section avatar>
                  <q-icon name="logout" />
                </q-item-section>
                <q-item-section>ÈÄÄÂá∫ÁôªÂΩï</q-item-section>
              </q-item>
            </q-list>
          </q-btn-dropdown>
        </div>
      </q-toolbar>
    </q-header>

    <q-drawer v-model="leftDrawerOpen" show-if-above bordered class="bg-grey-1">
      <q-list>
        <q-item-label header> ÂØºËà™ËèúÂçï </q-item-label>

        <!-- ‰ª™Ë°®Áõò - ‰øùÁïôÈùôÊÄÅËèúÂçï -->
        <q-item
          clickable
          v-ripple
          :active="$route.path === '/dashboard'"
          @click="navigateTo('/dashboard')"
        >
          <q-item-section avatar>
            <q-icon name="dashboard" />
          </q-item-section>
          <q-item-section> ‰ª™Ë°®Áõò </q-item-section>
        </q-item>

        <!-- Âä®ÊÄÅËèúÂçï -->
        <template v-for="menu in menuList" :key="menu.id">
          <q-expansion-item
            v-if="menu.children && menu.children.length > 0"
            :icon="menu.icon"
            :label="menu.menuName"
            :model-value="isMenuExpanded(menu)"
            @update:model-value="(val) => onMenuToggle(menu, val)"
          >
            <q-item
              v-for="child in menu.children"
              :key="child.id"
              clickable
              v-ripple
              :active="$route.path === child.path"
              @click="navigateTo(child.path)"
              class="q-ml-md"
            >
              <q-item-section avatar>
                <q-icon :name="child.icon" />
              </q-item-section>
              <q-item-section>
                {{ child.menuName }}
              </q-item-section>
            </q-item>
          </q-expansion-item>

          <q-item
            v-else
            clickable
            v-ripple
            :active="$route.path === menu.path"
            @click="navigateTo(menu.path)"
          >
            <q-item-section avatar>
              <q-icon :name="menu.icon" />
            </q-item-section>
            <q-item-section>
              {{ menu.menuName }}
            </q-item-section>
          </q-item>
        </template>
      </q-list>
    </q-drawer>

    <q-page-container>
      <router-view />
    </q-page-container>

    <!-- ‰øÆÊîπÂØÜÁ†ÅÂØπËØùÊ°Ü -->
    <q-dialog v-model="passwordDialog" persistent>
      <q-card style="min-width: 350px">
        <q-card-section>
          <div class="text-h6">‰øÆÊîπÂØÜÁ†Å</div>
        </q-card-section>

        <q-card-section class="q-pt-none">
          <q-form @submit="submitPasswordChange" class="q-gutter-md">
            <q-input
              v-model="passwordForm.oldPassword"
              type="password"
              label="ÂéüÂØÜÁ†Å"
              :rules="[(val) => !!val || 'ËØ∑ËæìÂÖ•ÂéüÂØÜÁ†Å']"
              outlined
              dense
            />

            <q-input
              v-model="passwordForm.newPassword"
              type="password"
              label="Êñ∞ÂØÜÁ†Å"
              :rules="[
                (val) => !!val || 'ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å',
                (val) => val.length >= 6 || 'ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë6‰Ωç',
              ]"
              outlined
              dense
            />

            <q-input
              v-model="passwordForm.confirmPassword"
              type="password"
              label="Á°ÆËÆ§ÂØÜÁ†Å"
              :rules="[
                (val) => !!val || 'ËØ∑Á°ÆËÆ§ÂØÜÁ†Å',
                (val) =>
                  val === passwordForm.newPassword || '‰∏§Ê¨°ÂØÜÁ†ÅËæìÂÖ•‰∏ç‰∏ÄËá¥',
              ]"
              outlined
              dense
            />

            <div class="row justify-end q-gutter-sm">
              <q-btn flat label="ÂèñÊ∂à" @click="passwordDialog = false" />
              <q-btn type="submit" color="primary" label="Á°ÆÂÆö" />
            </div>
          </q-form>
        </q-card-section>
      </q-card>
    </q-dialog>
  </q-layout>
</template>

<script>
import { defineComponent, ref, computed, onMounted, watch } from "vue";
import { useRouter, useRoute } from "vue-router";
import { useAuthStore } from "src/stores/auth";
import { useQuasar } from "quasar";
import { resetDynamicRoutes } from "src/router/dynamicRoutes";

export default defineComponent({
  name: "MainLayout",

  setup() {
    const $q = useQuasar();
    const router = useRouter();
    const route = useRoute();
    const authStore = useAuthStore();

    const leftDrawerOpen = ref(false);
    const passwordDialog = ref(false);
    const passwordForm = ref({
      oldPassword: "",
      newPassword: "",
      confirmPassword: "",
    });

    // ËèúÂçïÂ±ïÂºÄÁä∂ÊÄÅÁÆ°ÁêÜ
    const expandedMenus = ref(new Set());

    // ËÆ°ÁÆóÂ±ûÊÄß
    const userInfo = computed(() => authStore.userInfo);
    const menuList = computed(() => authStore.menus || []);

    // ÂàùÂßãÂåñËèúÂçïÂ±ïÂºÄÁä∂ÊÄÅ
    const initExpandedMenus = (menus) => {
      if (!menus || menus.length === 0) return;

      const currentPath = route.path;
      menus.forEach((menu) => {
        if (menu.children && menu.children.length > 0) {
          // Ê£ÄÊü•ÂΩìÂâçË∑ØÁî±ÊòØÂê¶Âú®Ëøô‰∏™ËèúÂçïÁöÑÂ≠êËèúÂçï‰∏≠
          const hasActiveChild = menu.children.some((child) =>
            currentPath.startsWith(child.path)
          );
          if (hasActiveChild) {
            expandedMenus.value.add(menu.id);
          }
        }
      });
    };

    // Êõ¥Êñ∞ËèúÂçïÂ±ïÂºÄÁä∂ÊÄÅ
    const updateExpandedMenus = (currentPath) => {
      const menus = authStore.menus || [];
      menus.forEach((menu) => {
        if (menu.children && menu.children.length > 0) {
          const hasActiveChild = menu.children.some((child) =>
            currentPath.startsWith(child.path)
          );
          if (hasActiveChild) {
            expandedMenus.value.add(menu.id);
          }
        }
      });
    };

    // Ê£ÄÊü•ËèúÂçïÊòØÂê¶ÊøÄÊ¥ª
    const isMenuActive = (menu) => {
      if (menu.children && menu.children.length > 0) {
        return menu.children.some((child) => route.path.startsWith(child.path));
      }
      return route.path === menu.path;
    };

    // Ê£ÄÊü•ËèúÂçïÊòØÂê¶Â∫îËØ•Â±ïÂºÄ
    const isMenuExpanded = (menu) => {
      return expandedMenus.value.has(menu.id) || isMenuActive(menu);
    };

    // Â§ÑÁêÜËèúÂçïÂ±ïÂºÄ/ÊäòÂè†‰∫ã‰ª∂
    const onMenuToggle = (menu, expanded) => {
      if (expanded) {
        expandedMenus.value.add(menu.id);
      } else {
        expandedMenus.value.delete(menu.id);
      }
    };

    // ÁõëÂê¨ËèúÂçïÊï∞ÊçÆÂèòÂåñ
    watch(
      () => authStore.menus,
      (newMenus) => {
        console.log("üìã MainLayout - ËèúÂçïÊï∞ÊçÆÂ∑≤Êõ¥Êñ∞:", newMenus);
        console.log("üìã MainLayout - ËèúÂçïÊï∞ÁªÑÈïøÂ∫¶:", newMenus?.length || 0);
        if (newMenus?.length > 0) {
          console.log("üìã MainLayout - Á¨¨‰∏Ä‰∏™ËèúÂçïÈ°π:", newMenus[0]);
          // ÂàùÂßãÂåñÂ±ïÂºÄÁä∂ÊÄÅÔºåÂ¶ÇÊûúÂΩìÂâçË∑ØÁî±Âú®Êüê‰∏™ËèúÂçï‰∏ãÔºåËá™Âä®Â±ïÂºÄËØ•ËèúÂçï
          initExpandedMenus(newMenus);
        }
      },
      { immediate: true }
    );

    // ÁõëÂê¨Ë∑ØÁî±ÂèòÂåñÔºåÊõ¥Êñ∞ËèúÂçïÂ±ïÂºÄÁä∂ÊÄÅ
    watch(
      () => route.path,
      (newPath) => {
        console.log("üö¶ Ë∑ØÁî±ÂèòÂåñ:", newPath);
        updateExpandedMenus(newPath);
      },
      { immediate: true }
    );

    // ÊñπÊ≥ï
    const toggleLeftDrawer = () => {
      leftDrawerOpen.value = !leftDrawerOpen.value;
    };

    const navigateTo = (path) => {
      router.push(path);
    };

    const goToProfile = () => {
      router.push("/profile");
    };

    const changePassword = () => {
      passwordDialog.value = true;
      passwordForm.value = {
        oldPassword: "",
        newPassword: "",
        confirmPassword: "",
      };
    };

    const submitPasswordChange = async () => {
      try {
        await authStore.changePassword({
          oldPassword: passwordForm.value.oldPassword,
          newPassword: passwordForm.value.newPassword,
        });

        $q.notify({
          type: "positive",
          message: "ÂØÜÁ†Å‰øÆÊîπÊàêÂäü",
        });

        passwordDialog.value = false;
      } catch (error) {
        $q.notify({
          type: "negative",
          message: error.message || "ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•",
        });
      }
    };

    const logout = async () => {
      $q.dialog({
        title: "Á°ÆËÆ§",
        message: "Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü",
        cancel: true,
        persistent: true,
      }).onOk(async () => {
        try {
          await authStore.logout();
          // Ê∏ÖÈô§Âä®ÊÄÅË∑ØÁî±
          resetDynamicRoutes(router);
          router.push("/login");
        } catch (error) {
          console.error("ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:", error);
          // Ê∏ÖÈô§Âä®ÊÄÅË∑ØÁî±
          resetDynamicRoutes(router);
          router.push("/login");
        }
      });
    };

    const loadUserMenus = async () => {
      try {
        console.log("üîÑ MainLayout - ÂºÄÂßãÂä†ËΩΩÁî®Êà∑ËèúÂçï");
        console.log("üîÑ MainLayout - ÂΩìÂâçtoken:", !!authStore.token);
        console.log(
          "üîÑ MainLayout - ÂΩìÂâçËèúÂçïÊï∞Èáè:",
          authStore.menus?.length || 0
        );

        if (authStore.token && !authStore.menus?.length) {
          await authStore.getUserMenus();
          console.log("‚úÖ MainLayout - ËèúÂçïÂä†ËΩΩÂÆåÊàê");
        } else {
          console.log("‚ÑπÔ∏è MainLayout - Ë∑≥ËøáËèúÂçïÂä†ËΩΩÔºåÂ∑≤Â≠òÂú®ÊàñÊó†token");
        }
      } catch (error) {
        console.error("‚ùå MainLayout - Âä†ËΩΩÁî®Êà∑ËèúÂçïÂ§±Ë¥•:", error);
      }
    };

    onMounted(() => {
      console.log("üöÄ MainLayout - ÁªÑ‰ª∂Â∑≤ÊåÇËΩΩ");
      console.log("üöÄ MainLayout - Áî®Êà∑‰ø°ÊÅØ:", userInfo.value);
      console.log("üöÄ MainLayout - ËèúÂçïÂàóË°®:", menuList.value);
      loadUserMenus();
    });

    return {
      leftDrawerOpen,
      passwordDialog,
      passwordForm,
      userInfo,
      menuList,
      expandedMenus,
      toggleLeftDrawer,
      navigateTo,
      goToProfile,
      changePassword,
      submitPasswordChange,
      logout,
      isMenuActive,
      isMenuExpanded,
      onMenuToggle,
    };
  },
});
</script>

<style lang="sass" scoped>
.q-toolbar__title
  font-size: 1.2rem
  font-weight: 500
</style>
