# ç™»å½•ã€æƒé™å’Œè·¯ç”±ç³»ç»Ÿé€»è¾‘è¯´æ˜

## ğŸ“‹ ç›®å½•ç»“æ„æ¦‚è§ˆ

```
src/
â”œâ”€â”€ boot/           # Quasarå¯åŠ¨æ–‡ä»¶
â”‚   â”œâ”€â”€ auth.js     # æƒé™æŒ‡ä»¤æ³¨å†Œï¼ˆv-permission, v-roleï¼‰
â”‚   â””â”€â”€ router.js   # è·¯ç”±å¯åŠ¨åˆå§‹åŒ–
â”œâ”€â”€ router/         # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ index.js    # è·¯ç”±å®ä¾‹å’Œå®ˆå«
â”‚   â”œâ”€â”€ routes.js   # é™æ€è·¯ç”±é…ç½®
â”‚   â””â”€â”€ dynamicRoutes.js  # åŠ¨æ€è·¯ç”±ç”Ÿæˆé€»è¾‘
â””â”€â”€ stores/         # çŠ¶æ€ç®¡ç†
    â””â”€â”€ auth.js     # è®¤è¯çŠ¶æ€ç®¡ç†
```

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

### 1. åº”ç”¨å¯åŠ¨æµç¨‹

```
åº”ç”¨å¯åŠ¨
    â†“
boot/router.js æ‰§è¡Œ
    â†“
æ£€æŸ¥æ˜¯å¦æœ‰tokenï¼Ÿ
    â”œâ”€ æœ‰ â†’ è°ƒç”¨ authStore.initializeAuth()
    â”‚       â†“
    â”‚       è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆgetUserInfoï¼‰
    â”‚       â†“
    â”‚       è·å–ç”¨æˆ·èœå•ï¼ˆgetUserMenusï¼‰
    â”‚       â†“
    â”‚       åˆå§‹åŒ–åŠ¨æ€è·¯ç”±ï¼ˆinitDynamicRoutesï¼‰
    â”‚       â†“
    â”‚       æ ‡è®° routesLoaded = true
    â”‚
    â””â”€ æ—  â†’ è·³è¿‡åˆå§‹åŒ–ï¼Œç­‰å¾…ç”¨æˆ·ç™»å½•
```

### 2. ç”¨æˆ·ç™»å½•æµç¨‹

```
ç”¨æˆ·è®¿é—®ç™»å½•é¡µï¼ˆ/loginï¼‰
    â†“
è¾“å…¥ç”¨æˆ·åã€å¯†ç 
    â†“
å®Œæˆæ»‘å—éªŒè¯ç 
    â†“
ç‚¹å‡»ç™»å½•æŒ‰é’®
    â†“
è°ƒç”¨ authStore.login(loginData)
    â”œâ”€ è°ƒç”¨åç«¯ç™»å½•API
    â”œâ”€ ä¿å­˜ token å’Œ refreshToken
    â”œâ”€ ä¿å­˜ userInfo åˆ° localStorage
    â”œâ”€ è°ƒç”¨ getUserInfo() è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
    â””â”€ è°ƒç”¨ getUserMenus() è·å–ç”¨æˆ·èœå•
    â†“
LoginPage.vue æ‰‹åŠ¨åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
    â†“
è·³è½¬åˆ°é¦–é¡µæˆ–é‡å®šå‘URL
```

### 3. è·¯ç”±å®ˆå«æµç¨‹

```
ç”¨æˆ·è®¿é—®ä»»æ„è·¯ç”±
    â†“
router/index.js beforeEach å®ˆå«æ‹¦æˆª
    â†“
æ˜¯å¦åœ¨ç™½åå•ï¼ˆ/login, /register, /404ï¼‰ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ç›´æ¥æ”¾è¡Œ
    â””â”€ å¦ â†’ ç»§ç»­æ£€æŸ¥
        â†“
        æ˜¯å¦æœ‰ tokenï¼Ÿ
        â”œâ”€ æ—  â†’ é‡å®šå‘åˆ° /login
        â””â”€ æœ‰ â†’ ç»§ç»­æ£€æŸ¥
            â†“
            æ˜¯å¦æœ‰ userInfoï¼Ÿ
            â”œâ”€ æ—  â†’ è·å–ç”¨æˆ·ä¿¡æ¯ + èœå• + åˆå§‹åŒ–è·¯ç”±
            â””â”€ æœ‰ â†’ ç»§ç»­æ£€æŸ¥
                â†“
                åŠ¨æ€è·¯ç”±æ˜¯å¦å·²åŠ è½½ï¼Ÿ
                â”œâ”€ æ—  â†’ åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
                â””â”€ æœ‰ â†’ æ”¾è¡Œ
```

---

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶è¯¦è§£

### 1. `stores/auth.js` - è®¤è¯çŠ¶æ€ç®¡ç†

**æ ¸å¿ƒèŒè´£ï¼š**
- ç®¡ç†ç”¨æˆ·è®¤è¯çŠ¶æ€ï¼ˆtokenã€userInfoã€permissionsã€rolesã€menusï¼‰
- æä¾›ç™»å½•ã€ç™»å‡ºã€åˆ·æ–°tokenç­‰æ–¹æ³•
- ç®¡ç†æƒé™å’Œèœå•æ•°æ®

**å…³é”®çŠ¶æ€ï¼š**
```javascript
state: {
  token: null,              // è®¿é—®ä»¤ç‰Œ
  refreshToken: null,       // åˆ·æ–°ä»¤ç‰Œ
  userInfo: null,           // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆæŒä¹…åŒ–åˆ°localStorageï¼‰
  permissions: [],          // ç”¨æˆ·æƒé™åˆ—è¡¨ï¼ˆä¸æŒä¹…åŒ–ï¼Œæ¯æ¬¡å®æ—¶è·å–ï¼‰
  roles: [],               // ç”¨æˆ·è§’è‰²åˆ—è¡¨ï¼ˆä¸æŒä¹…åŒ–ï¼‰
  menus: [],               // ç”¨æˆ·èœå•æ ‘ï¼ˆä¸æŒä¹…åŒ–ï¼‰
  routesLoaded: false,     // åŠ¨æ€è·¯ç”±æ˜¯å¦å·²åŠ è½½
  isInitializing: false,   // æ˜¯å¦æ­£åœ¨åˆå§‹åŒ–
  redirectUrl: null        // ç™»å½•åé‡å®šå‘URL
}
```

**å…³é”®æ–¹æ³•ï¼š**

#### `login(loginData)` - ç™»å½•
1. è°ƒç”¨åç«¯ç™»å½•API
2. ä¿å­˜ token å’Œ refreshToken åˆ° state å’Œ localStorage
3. å¦‚æœå“åº”åŒ…å« userInfoï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™è°ƒç”¨ getUserInfo()
4. è°ƒç”¨ getUserMenus() è·å–èœå•æ•°æ®

#### `getUserInfo()` - è·å–ç”¨æˆ·ä¿¡æ¯
1. è°ƒç”¨åç«¯APIè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
2. ä»å“åº”ä¸­æå– userInfoã€permissionsã€roles
3. åªå°† userInfo ä¿å­˜åˆ° localStorageï¼ˆæƒé™æ•°æ®ä¸æŒä¹…åŒ–ï¼‰

#### `getUserMenus()` - è·å–ç”¨æˆ·èœå•
1. è°ƒç”¨åç«¯APIè·å–èœå•æ ‘
2. ä»èœå•æ ‘ä¸­æå–æƒé™æ ‡è¯†
3. åˆå¹¶åˆ° permissions æ•°ç»„ä¸­
4. ä¸ä¿å­˜åˆ° localStorageï¼ˆç¡®ä¿å®æ—¶æ›´æ–°ï¼‰

#### `initializeAuth()` - åˆå§‹åŒ–è®¤è¯ä¿¡æ¯
1. æ£€æŸ¥æ˜¯å¦æœ‰ token
2. è°ƒç”¨ getUserInfo()
3. è°ƒç”¨ getUserMenus()
4. ç”¨äºåº”ç”¨å¯åŠ¨æ—¶æ¢å¤ç”¨æˆ·çŠ¶æ€

#### `clearAuth()` - æ¸…é™¤è®¤è¯ä¿¡æ¯
1. æ¸…ç©ºæ‰€æœ‰çŠ¶æ€
2. æ¸…é™¤ localStorage ä¸­çš„è®¤è¯æ•°æ®
3. æ¸…é™¤åŠ¨æ€è·¯ç”±ç»„ä»¶æ˜ å°„ç¼“å­˜

---

### 2. `router/index.js` - è·¯ç”±å®ˆå«

**æ ¸å¿ƒèŒè´£ï¼š**
- åˆ›å»ºè·¯ç”±å®ä¾‹
- å®ç°è·¯ç”±å®ˆå«é€»è¾‘
- æ§åˆ¶é¡µé¢è®¿é—®æƒé™

**è·¯ç”±å®ˆå«é€»è¾‘ï¼ˆbeforeEachï¼‰ï¼š**

```javascript
// 1. ç™½åå•æ£€æŸ¥
if (whiteList.includes(to.path)) {
  next()  // ç›´æ¥æ”¾è¡Œ
  return
}

// 2. ç™»å½•æ£€æŸ¥
if (!authStore.token) {
  next('/login')  // æœªç™»å½•ï¼Œè·³è½¬ç™»å½•é¡µ
  return
}

// 3. ç”¨æˆ·ä¿¡æ¯æ£€æŸ¥
if (!authStore.userInfo) {
  // è·å–ç”¨æˆ·ä¿¡æ¯å’Œèœå•
  await authStore.getUserInfo()
  await authStore.getUserMenus()
  // åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
  await initDynamicRoutes(Router, false)
  authStore.routesLoaded = true
  next()
  return
}

// 4. åŠ¨æ€è·¯ç”±æ£€æŸ¥
if (!authStore.routesLoaded) {
  // ç¡®ä¿èœå•æ•°æ®å­˜åœ¨
  if (!authStore.menus || authStore.menus.length === 0) {
    await authStore.getUserMenus()
  }
  // åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
  await initDynamicRoutes(Router, false)
  authStore.routesLoaded = true
  next()
  return
}

// 5. æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œæ”¾è¡Œ
next()
```

**ç‰¹æ®Šå¤„ç†ï¼š**
- å¦‚æœç›®æ ‡è·¯ç”±æ˜¯æ ¹è·¯å¾„ `/`ï¼Œé‡å®šå‘åˆ° `/dashboard`
- å¦‚æœè·¯ç”±åˆå§‹åŒ–å¤±è´¥ï¼Œå…è®¸è®¿é—®åŸºç¡€é¡µé¢ï¼ˆdashboardã€profileï¼‰
- æ”¯æŒè·¯ç”±ä¸å­˜åœ¨æ—¶çš„é‡æ–°åˆå§‹åŒ–æœºåˆ¶

---

### 3. `router/routes.js` - é™æ€è·¯ç”±é…ç½®

**æ ¸å¿ƒèŒè´£ï¼š**
- å®šä¹‰åº”ç”¨çš„åŸºç¡€é™æ€è·¯ç”±
- åŒ…å«ç™»å½•é¡µã€ä¸»å¸ƒå±€ã€404é¡µé¢ç­‰

**è·¯ç”±ç»“æ„ï¼š**
```javascript
[
  { path: '/login', component: LoginPage },           // ç™»å½•é¡µ
  { 
    path: '/', 
    name: 'MainLayout',
    component: MainLayout,
    redirect: '/dashboard',
    children: [
      { path: 'dashboard', component: DashboardPage }, // ä»ªè¡¨ç›˜
      { path: 'profile', component: ProfilePage }      // ä¸ªäººä¸­å¿ƒ
    ]
  },
  { path: '/404', component: ErrorNotFound },         // 404é¡µé¢
  { path: '/:catchAll(.*)*', redirect: '/404' }       // æ•è·æ‰€æœ‰æœªåŒ¹é…è·¯ç”±
]
```

---

### 4. `router/dynamicRoutes.js` - åŠ¨æ€è·¯ç”±ç”Ÿæˆ

**æ ¸å¿ƒèŒè´£ï¼š**
- æ ¹æ®åç«¯è¿”å›çš„èœå•æ•°æ®ç”ŸæˆåŠ¨æ€è·¯ç”±
- ç®¡ç†ç»„ä»¶æ˜ å°„å…³ç³»
- æä¾›è·¯ç”±æ³¨å†Œå’Œæ¸…ç†åŠŸèƒ½

**å…³é”®æ¦‚å¿µï¼š**

#### ç»„ä»¶æ˜ å°„è¡¨ï¼ˆcomponentMapï¼‰
- ä½¿ç”¨ `import.meta.glob` é¢„åŠ è½½æ‰€æœ‰é¡µé¢ç»„ä»¶
- ä»åç«¯APIè·å–ç»„ä»¶è·¯å¾„æ˜ å°„é…ç½®
- æ”¯æŒå¤šç§è·¯å¾„æ ¼å¼çš„è§„èŒƒåŒ–

#### è·¯å¾„è§„èŒƒåŒ–ï¼ˆnormalizeComponentPathï¼‰
æ”¯æŒä»¥ä¸‹è·¯å¾„æ ¼å¼ï¼š
- `system/user` â†’ åŸå§‹è·¯å¾„
- `pages/system/user` â†’ æ·»åŠ pageså‰ç¼€
- `pages/system/userPage` â†’ é¡µé¢ç»„ä»¶æ ¼å¼
- `system/user/UserPage` â†’ æ ‡å‡†é¡µé¢è·¯å¾„

#### èœå•è½¬è·¯ç”±ï¼ˆtransformMenuToRouteï¼‰
```javascript
èœå•æ•°æ®ç»“æ„ï¼š
{
  menuId: 1,
  menuName: "ç”¨æˆ·ç®¡ç†",
  menuType: 1,        // 0=ç›®å½•, 1=èœå•, 2=æŒ‰é’®
  path: "/system/user",
  component: "system/user",
  icon: "people",
  permission: "system:user:list",
  isVisible: 1,
  isCache: 1,
  children: [...]
}

è½¬æ¢ä¸ºè·¯ç”±ï¼š
{
  path: "system/user",
  name: "SystemUser",
  component: () => import('../pages/system/user/UserPage.vue'),
  meta: {
    title: "ç”¨æˆ·ç®¡ç†",
    icon: "people",
    permission: "system:user:list",
    keepAlive: true,
    hidden: false
  }
}
```

**å…³é”®æ–¹æ³•ï¼š**

#### `loadComponentMappingFromAPI()` - åŠ è½½ç»„ä»¶æ˜ å°„
1. è°ƒç”¨åç«¯APIè·å–ç»„ä»¶æ˜ å°„é…ç½®
2. æ¸…ç©ºç°æœ‰æ˜ å°„
3. æ³¨å†Œæ–°çš„ç»„ä»¶æ˜ å°„åˆ° componentMap
4. ä½¿ç”¨ `import.meta.glob` é¢„åŠ è½½çš„æ¨¡å—è¿›è¡ŒåŠ¨æ€å¯¼å…¥

#### `getUserRoutes()` - è·å–ç”¨æˆ·è·¯ç”±
1. ä»APIæˆ–localStorageè·å–èœå•æ•°æ®
2. ç¡®ä¿ç»„ä»¶æ˜ å°„å·²åŠ è½½
3. éå†èœå•æ ‘ï¼Œè½¬æ¢ä¸ºè·¯ç”±é…ç½®
4. è¿”å›è·¯ç”±æ•°ç»„

#### `addDynamicRoutes(router, routes)` - æ·»åŠ åŠ¨æ€è·¯ç”±
1. éå†è·¯ç”±æ•°ç»„
2. ä½¿ç”¨ `router.addRoute('MainLayout', route)` æ·»åŠ åˆ°ä¸»å¸ƒå±€ä¸‹
3. è®°å½•æˆåŠŸå’Œå¤±è´¥çš„æ•°é‡

#### `initDynamicRoutes(router, usePersistedMenus)` - åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
1. è·å–ç”¨æˆ·è·¯ç”±é…ç½®
2. æ·»åŠ åŠ¨æ€è·¯ç”±åˆ°è·¯ç”±å®ä¾‹
3. è¿”å›åˆå§‹åŒ–ç»“æœ

#### `resetDynamicRoutes(router)` - é‡ç½®åŠ¨æ€è·¯ç”±
1. è·å–æ‰€æœ‰è·¯ç”±
2. ç§»é™¤éåŸºç¡€è·¯ç”±ï¼ˆä¿ç•™ dashboardã€profile ç­‰ï¼‰
3. ç”¨äºç™»å‡ºæ—¶æ¸…ç†è·¯ç”±

---

### 5. `boot/router.js` - è·¯ç”±å¯åŠ¨åˆå§‹åŒ–

**æ ¸å¿ƒèŒè´£ï¼š**
- åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
- å¦‚æœå·²ç™»å½•ï¼Œåˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯å’ŒåŠ¨æ€è·¯ç”±

**æ‰§è¡Œæµç¨‹ï¼š**
```javascript
if (authStore.token) {
  // 1. è®¾ç½®åˆå§‹åŒ–çŠ¶æ€
  authStore.isInitializing = true
  
  // 2. å»¶è¿Ÿç¡®ä¿æ¨¡å—åŠ è½½å®Œæˆ
  await new Promise(resolve => setTimeout(resolve, 100))
  
  // 3. è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯å’Œèœå•
  await authStore.initializeAuth()
  
  // 4. åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
  const routeSuccess = await initDynamicRoutes(router, true)
  
  // 5. æ ‡è®°è·¯ç”±å·²åŠ è½½
  if (routeSuccess) {
    authStore.routesLoaded = true
  }
  
  authStore.isInitializing = false
}
```

**é”™è¯¯å¤„ç†ï¼š**
- å¦‚æœè·å–æƒé™æ•°æ®å¤±è´¥ï¼ˆ401é”™è¯¯ï¼‰ï¼Œæ¸…é™¤è®¤è¯ä¿¡æ¯
- é˜²æ­¢tokenè¿‡æœŸå¯¼è‡´çš„æ— é™å¾ªç¯

---

### 6. `boot/auth.js` - æƒé™æŒ‡ä»¤

**æ ¸å¿ƒèŒè´£ï¼š**
- æ³¨å†Œå…¨å±€æƒé™æŒ‡ä»¤
- æä¾›æ¨¡æ¿ä¸­çš„æƒé™æ§åˆ¶

**æŒ‡ä»¤è¯´æ˜ï¼š**

#### `v-permission` - æƒé™æŒ‡ä»¤
```vue
<!-- åªæœ‰æ‹¥æœ‰ system:user:delete æƒé™çš„ç”¨æˆ·æ‰èƒ½çœ‹åˆ°æ­¤æŒ‰é’® -->
<q-btn v-permission="'system:user:delete'" label="åˆ é™¤" />
```

å®ç°é€»è¾‘ï¼š
```javascript
app.directive('permission', {
  mounted(el, binding) {
    const authStore = useAuthStore()
    if (!authStore.hasPermission(binding.value)) {
      el.parentNode?.removeChild(el)  // ç§»é™¤DOMå…ƒç´ 
    }
  }
})
```

#### `v-role` - è§’è‰²æŒ‡ä»¤
```vue
<!-- åªæœ‰ç®¡ç†å‘˜è§’è‰²æ‰èƒ½çœ‹åˆ°æ­¤æŒ‰é’® -->
<q-btn v-role="'admin'" label="ç®¡ç†" />
```

å®ç°é€»è¾‘ï¼š
```javascript
app.directive('role', {
  mounted(el, binding) {
    const authStore = useAuthStore()
    if (!authStore.hasRole(binding.value)) {
      el.parentNode?.removeChild(el)  // ç§»é™¤DOMå…ƒç´ 
    }
  }
})
```

---

## ğŸ” æƒé™æ§åˆ¶æœºåˆ¶

### 1. æ•°æ®æ¥æº

**æƒé™æ•°æ®æœ‰ä¸¤ä¸ªæ¥æºï¼š**

1. **ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼ˆgetUserInfoï¼‰**
   - è¿”å›ç”¨æˆ·çš„åŸºæœ¬æƒé™åˆ—è¡¨
   - æ ¼å¼ï¼š`['system:user:list', 'system:user:add', ...]`

2. **èœå•æ¥å£ï¼ˆgetUserMenusï¼‰**
   - è¿”å›èœå•æ ‘ç»“æ„
   - ä»èœå•çš„ `permission` å­—æ®µæå–æƒé™
   - ä¸ç”¨æˆ·ä¿¡æ¯æ¥å£çš„æƒé™åˆå¹¶

**åˆå¹¶é€»è¾‘ï¼š**
```javascript
// ä»èœå•æ ‘æå–æƒé™
const menuPermissions = extractPermissionsFromMenus(menus)

// åˆå¹¶å»é‡
const allPermissions = [
  ...new Set([...existingPermissions, ...menuPermissions])
]

this.permissions = allPermissions
```

### 2. æƒé™æ£€æŸ¥æ–¹å¼

#### æ–¹å¼1: ä½¿ç”¨æŒ‡ä»¤ï¼ˆæ¨èï¼‰
```vue
<template>
  <q-btn v-permission="'system:user:delete'" label="åˆ é™¤" />
</template>
```

#### æ–¹å¼2: ä½¿ç”¨æ–¹æ³•
```vue
<template>
  <q-btn v-if="authStore.hasPermission('system:user:delete')" label="åˆ é™¤" />
</template>

<script setup>
import { useAuthStore } from 'src/stores/auth'
const authStore = useAuthStore()
</script>
```

#### æ–¹å¼3: åœ¨è·¯ç”±metaä¸­å®šä¹‰
```javascript
{
  path: 'user',
  component: UserPage,
  meta: {
    permission: 'system:user:list'  // è·¯ç”±çº§åˆ«çš„æƒé™æ§åˆ¶
  }
}
```

### 3. æ•°æ®æŒä¹…åŒ–ç­–ç•¥

**æŒä¹…åŒ–åˆ° localStorageï¼š**
- âœ… token
- âœ… refreshToken
- âœ… userInfoï¼ˆç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼‰
- âœ… redirectUrlï¼ˆé‡å®šå‘URLï¼‰

**ä¸æŒä¹…åŒ–ï¼ˆæ¯æ¬¡å®æ—¶è·å–ï¼‰ï¼š**
- âŒ permissionsï¼ˆæƒé™åˆ—è¡¨ï¼‰
- âŒ rolesï¼ˆè§’è‰²åˆ—è¡¨ï¼‰
- âŒ menusï¼ˆèœå•æ ‘ï¼‰

**åŸå› ï¼š**
- ç¡®ä¿æƒé™æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°çš„
- é¿å…æƒé™å˜æ›´åç”¨æˆ·ä»ä½¿ç”¨æ—§æƒé™
- é˜²æ­¢localStorageæ•°æ®è¿‡å¤§

---

## ğŸš€ å…¸å‹åœºæ™¯æµç¨‹

### åœºæ™¯1: é¦–æ¬¡ç™»å½•

```
1. ç”¨æˆ·è®¿é—® /login
2. è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œå®ŒæˆéªŒè¯ç 
3. ç‚¹å‡»ç™»å½•
   â”œâ”€ authStore.login() è°ƒç”¨ç™»å½•API
   â”œâ”€ ä¿å­˜ token åˆ° localStorage
   â”œâ”€ è·å– userInfo å¹¶ä¿å­˜
   â”œâ”€ è·å– menus å’Œ permissionsï¼ˆä¸ä¿å­˜ï¼‰
4. LoginPage æ‰‹åŠ¨åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
   â”œâ”€ loadComponentMappingFromAPI() åŠ è½½ç»„ä»¶æ˜ å°„
   â”œâ”€ getUserRoutes() ç”Ÿæˆè·¯ç”±é…ç½®
   â”œâ”€ addDynamicRoutes() æ³¨å†Œè·¯ç”±
5. è·³è½¬åˆ°é¦–é¡µ /dashboard
```

### åœºæ™¯2: åˆ·æ–°é¡µé¢

```
1. é¡µé¢åˆ·æ–°ï¼Œåº”ç”¨é‡æ–°å¯åŠ¨
2. boot/router.js æ‰§è¡Œ
   â”œâ”€ æ£€æµ‹åˆ° localStorage ä¸­æœ‰ token
   â”œâ”€ è°ƒç”¨ authStore.initializeAuth()
   â”‚   â”œâ”€ getUserInfo() è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
   â”‚   â””â”€ getUserMenus() è·å–æœ€æ–°èœå•
   â”œâ”€ initDynamicRoutes() åˆå§‹åŒ–è·¯ç”±
   â””â”€ æ ‡è®° routesLoaded = true
3. è·¯ç”±å®ˆå«æ£€æŸ¥
   â”œâ”€ æœ‰ token âœ“
   â”œâ”€ æœ‰ userInfo âœ“
   â”œâ”€ routesLoaded = true âœ“
   â””â”€ æ”¾è¡Œ
4. æ­£å¸¸è®¿é—®é¡µé¢
```

### åœºæ™¯3: ç›´æ¥è®¿é—®å—ä¿æŠ¤é¡µé¢

```
1. ç”¨æˆ·åœ¨æµè§ˆå™¨è¾“å…¥ /system/user
2. è·¯ç”±å®ˆå«æ‹¦æˆª
   â”œâ”€ ä¸åœ¨ç™½åå•
   â”œâ”€ æ£€æŸ¥ token
   â”‚   â”œâ”€ æ—  token â†’ ä¿å­˜ redirectUrl = /system/user
   â”‚   â””â”€ è·³è½¬åˆ° /login
3. ç”¨æˆ·ç™»å½•æˆåŠŸ
   â”œâ”€ è·å– redirectUrl
   â”œâ”€ åˆå§‹åŒ–åŠ¨æ€è·¯ç”±
   â””â”€ è·³è½¬åˆ° /system/user
```

### åœºæ™¯4: ç™»å‡º

```
1. ç”¨æˆ·ç‚¹å‡»ç™»å‡ºæŒ‰é’®
2. è°ƒç”¨ authStore.logout()
   â”œâ”€ è°ƒç”¨åç«¯ç™»å‡ºAPI
   â”œâ”€ æ‰§è¡Œ clearAuth()
   â”‚   â”œâ”€ æ¸…ç©ºæ‰€æœ‰ state
   â”‚   â”œâ”€ æ¸…é™¤ localStorage
   â”‚   â””â”€ è°ƒç”¨ clearAllComponents() æ¸…é™¤ç»„ä»¶æ˜ å°„
   â””â”€ resetDynamicRoutes() æ¸…é™¤åŠ¨æ€è·¯ç”±
3. è·³è½¬åˆ° /login
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### 1. ç™½åå•è·¯ç”±

åœ¨ `router/index.js` ä¸­é…ç½®ï¼š
```javascript
const whiteList = ['/login', '/register', '/404']
```

è¿™äº›è·¯ç”±ä¸éœ€è¦ç™»å½•å³å¯è®¿é—®ã€‚

### 2. åŸºç¡€è·¯ç”±

åœ¨ `router/routes.js` ä¸­å®šä¹‰çš„é™æ€è·¯ç”±ï¼š
- `/login` - ç™»å½•é¡µ
- `/` - ä¸»å¸ƒå±€
- `/dashboard` - ä»ªè¡¨ç›˜
- `/profile` - ä¸ªäººä¸­å¿ƒ
- `/404` - 404é¡µé¢

### 3. åŠ¨æ€è·¯ç”±

ç”±åç«¯èœå•æ¥å£è¿”å›ï¼Œå‰ç«¯åŠ¨æ€ç”Ÿæˆï¼š
- æ ¹æ®ç”¨æˆ·æƒé™åŠ¨æ€æ·»åŠ 
- æ”¯æŒå¤šçº§åµŒå¥—
- æ”¯æŒæƒé™æ§åˆ¶

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. åˆ·æ–°é¡µé¢ååŠ¨æ€è·¯ç”±ä¸¢å¤±

**åŸå› ï¼š** åŠ¨æ€è·¯ç”±ä¸æŒä¹…åŒ–ï¼Œåˆ·æ–°åéœ€è¦é‡æ–°åŠ è½½

**è§£å†³ï¼š** boot/router.js åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–è·¯ç”±

### 2. æƒé™æ›´æ–°åä¸ç”Ÿæ•ˆ

**åŸå› ï¼š** æƒé™æ•°æ®ç¼“å­˜åœ¨ store ä¸­

**è§£å†³ï¼š** 
- æƒé™æ•°æ®ä¸æŒä¹…åŒ–åˆ° localStorage
- æ¯æ¬¡å¯åŠ¨éƒ½é‡æ–°è·å–æœ€æ–°æƒé™
- æˆ–è€…æ‰‹åŠ¨è°ƒç”¨ `authStore.getUserInfo()` åˆ·æ–°

### 3. ç»„ä»¶åŠ è½½å¤±è´¥

**åŸå› ï¼š** ç»„ä»¶è·¯å¾„æ˜ å°„ä¸æ­£ç¡®

**è§£å†³ï¼š**
- æ£€æŸ¥åç«¯è¿”å›çš„ç»„ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®ä¿ç»„ä»¶æ–‡ä»¶å­˜åœ¨äº `src/pages/` ç›®å½•
- æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤è·¯å¾„åŒ¹é…é€»è¾‘

### 4. è·¯ç”±å®ˆå«æ­»å¾ªç¯

**åŸå› ï¼š** tokenè¿‡æœŸä½†æœªæ¸…é™¤ï¼Œå¯¼è‡´ä¸æ–­å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯

**è§£å†³ï¼š**
- åœ¨ getUserInfo å¤±è´¥æ—¶æ£€æŸ¥ 401 é”™è¯¯
- è‡ªåŠ¨è°ƒç”¨ clearAuth() æ¸…é™¤è¿‡æœŸtoken
- é‡å®šå‘åˆ°ç™»å½•é¡µ

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æƒé™æ§åˆ¶

- âœ… ä¼˜å…ˆä½¿ç”¨ `v-permission` æŒ‡ä»¤
- âœ… æŒ‰é’®çº§æƒé™æ§åˆ¶åœ¨æ¨¡æ¿ä¸­å®Œæˆ
- âœ… è·¯ç”±çº§æƒé™åœ¨ meta ä¸­å®šä¹‰
- âŒ é¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æƒé™å­—ç¬¦ä¸²

### 2. è·¯ç”±ç®¡ç†

- âœ… é™æ€è·¯ç”±æ”¾åœ¨ routes.js
- âœ… åŠ¨æ€è·¯ç”±ç”±åç«¯èœå•ç”Ÿæˆ
- âœ… ä½¿ç”¨è·¯ç”±æ‡’åŠ è½½æå‡æ€§èƒ½
- âŒ ä¸è¦æ‰‹åŠ¨ä¿®æ”¹åŠ¨æ€è·¯ç”±

### 3. çŠ¶æ€ç®¡ç†

- âœ… æ•æ„Ÿæ•°æ®ï¼ˆtokenï¼‰æŒä¹…åŒ–
- âœ… æƒé™æ•°æ®å®æ—¶è·å–
- âœ… ä½¿ç”¨ getter å°è£…æƒé™æ£€æŸ¥é€»è¾‘
- âŒ ä¸è¦åœ¨ç»„ä»¶ä¸­ç›´æ¥ä¿®æ”¹ store

### 4. é”™è¯¯å¤„ç†

- âœ… æ•è·æ‰€æœ‰å¼‚æ­¥æ“ä½œçš„é”™è¯¯
- âœ… 401é”™è¯¯è‡ªåŠ¨æ¸…é™¤è®¤è¯ä¿¡æ¯
- âœ… æä¾›å‹å¥½çš„é”™è¯¯æç¤º
- âŒ ä¸è¦å¿½ç•¥é”™è¯¯

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è·¯ç”±çŠ¶æ€

```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
router.getRoutes()  // æŸ¥çœ‹æ‰€æœ‰å·²æ³¨å†Œè·¯ç”±
```

### 2. æŸ¥çœ‹æƒé™æ•°æ®

```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
import { useAuthStore } from 'src/stores/auth'
const authStore = useAuthStore()
console.log(authStore.permissions)  // æŸ¥çœ‹æƒé™åˆ—è¡¨
console.log(authStore.menus)        // æŸ¥çœ‹èœå•æ ‘
```

### 3. æŸ¥çœ‹ç»„ä»¶æ˜ å°„

```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
import { getComponentMapInfo } from 'src/router/dynamicRoutes'
console.log(getComponentMapInfo())  // æŸ¥çœ‹ç»„ä»¶æ˜ å°„ä¿¡æ¯
```

### 4. å¯ç”¨è¯¦ç»†æ—¥å¿—

ä»£ç ä¸­å·²åŒ…å«è¯¦ç»†çš„ console.logï¼ŒæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼š
- ğŸš¦ è·¯ç”±å®ˆå«æ—¥å¿—
- ğŸ” ç™»å½•æµç¨‹æ—¥å¿—
- ğŸ“‹ èœå•åŠ è½½æ—¥å¿—
- ğŸ›£ï¸ è·¯ç”±åˆå§‹åŒ–æ—¥å¿—

---

## ğŸ“š ç›¸å…³APIæ¥å£

### 1. è®¤è¯ç›¸å…³

- `POST /auth/login` - ç™»å½•
- `POST /auth/logout` - ç™»å‡º
- `POST /auth/refresh` - åˆ·æ–°token
- `GET /auth/userinfo` - è·å–ç”¨æˆ·ä¿¡æ¯

### 2. èœå•ç›¸å…³

- `GET /menu/user-menus` - è·å–ç”¨æˆ·èœå•æ ‘
- `GET /menu/component-mapping` - è·å–ç»„ä»¶è·¯å¾„æ˜ å°„

---

## ğŸ¯ æ€»ç»“

è¿™å¥—ç³»ç»Ÿå®ç°äº†ï¼š

1. **å®Œæ•´çš„è®¤è¯æµç¨‹**
   - ç™»å½•/ç™»å‡º
   - Tokenç®¡ç†
   - è‡ªåŠ¨åˆ·æ–°

2. **çµæ´»çš„æƒé™æ§åˆ¶**
   - æŒ‡ä»¤çº§æ§åˆ¶
   - è·¯ç”±çº§æ§åˆ¶
   - æŒ‰é’®çº§æ§åˆ¶

3. **åŠ¨æ€è·¯ç”±ç³»ç»Ÿ**
   - æ ¹æ®æƒé™åŠ¨æ€ç”Ÿæˆ
   - æ”¯æŒå¤šçº§åµŒå¥—
   - è‡ªåŠ¨ç»„ä»¶æ˜ å°„

4. **è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**
   - åˆ·æ–°é¡µé¢ä¿æŒç™»å½•çŠ¶æ€
   - è‡ªåŠ¨é‡å®šå‘åˆ°ç›®æ ‡é¡µé¢
   - å‹å¥½çš„é”™è¯¯æç¤º

5. **å®‰å…¨æ€§ä¿éšœ**
   - æƒé™å®æ—¶éªŒè¯
   - Tokenè¿‡æœŸè‡ªåŠ¨å¤„ç†
   - æ•æ„Ÿæ•°æ®åŠ å¯†ä¼ è¾“
